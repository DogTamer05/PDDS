<!DOCTYPE html>
<html>
<head>
<title>Engine Motor Details</title>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
<style>
  .center { text-align:center; }
</style>
</head>
<body class="w3-light-grey">

<div class="w3-content" style="max-width:800px">

  <header class="w3-container w3-center w3-padding-32"> 
    <h1 id="equipName">Loading...</h1>
    <p id="equipSubtext">Fetching equipment details...</p>
    <p id="equipDescription" style="font-style:italic;">—</p>
    <!-- Debugging: show raw JSON response -->
    <pre id="debugResponse" 
     style="
       text-align:left; 
       min-height:50px;           /* ensures it’s visible even if empty */
       max-height:200px; 
       overflow:auto; 
       background:#f1f1f1; 
       padding:10px; 
       border-radius:5px;
       border:1px solid #ccc;    /* add border to make it obvious */
       display:block;
       color: black;
     ">
  </pre>
  <div class="w3-card-4 w3-white w3-margin" id="infoCard" style="display:none;">
    <div class="w3-container w3-padding">
      <h2>Equipment Info</h2>
      <p><b>Description:</b> <span id="description">—</span></p>
      <img id="image" src="" alt="Equipment Image" style="width:100%;display:none;">
    </div>
  </div>

  <div class="center w3-margin" id="notFound" style="display:none;">
    <h3>⚠ No equipment found for this QR code</h3>
  </div>

</div>

<script>
// Retrieve QR code stored from scanner page
const scannedCode = sessionStorage.getItem("qr_code");

// If no QR code exists, show error & stop
if (!scannedCode) {
  document.getElementById("equipName").innerText = "Invalid Access";
  document.getElementById("equipSubtext").innerText = "No QR code found in session.";
  document.getElementById("equipDescription").innerText = "";
} else {
  fetchEquipment(); // <-- call fetch normally
}

async function fetchEquipment() {
  try {
    const response = await fetch(
      "https://ttdahvmsqjfarktnnxui.supabase.co/functions/v1/fetch-equipment",
      {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0ZGFodm1zcWpmYXJrdG5ueHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MDc5NzcsImV4cCI6MjA4MDM4Mzk3N30.-zkEnkG8Abr9CA8YrianySfXoZwPnZ31MpsUIuA1-u8"
        },
        body: JSON.stringify({ qr: scannedCode })
      }
    );

    const text = await response.text();
    let data;

    // Parse JSON safely
    try { data = JSON.parse(text); }
    catch { data = { error: "Invalid JSON", raw: text }; }

    // Always show debug output
    document.getElementById("debugResponse").innerText =
      JSON.stringify({ scannedCode, response: {status:response.status}, data }, null, 2);

    // Check response validity
    if (!response.ok || !data || data.error || (Array.isArray(data) && data.length === 0)) {
      document.getElementById("equipName").innerText = "Not Found";
      document.getElementById("equipSubtext").innerText = data?.error ?? "QR not found";
      document.getElementById("notFound").style.display = "block";
      return;
    }

    // Use first row if array returned
    const row = Array.isArray(data) ? data[0] : data;

    // Update UI
    document.getElementById("equipName").innerText = row.equipment_name ?? "No Name";
    document.getElementById("equipSubtext").innerText = row.type ?? "";
    document.getElementById("equipDescription").innerText = row.description ?? "No description";

    document.getElementById("infoCard").style.display = "block";
    document.getElementById("description").innerText = row.description ?? "No description";

    if (row.image_url) {
      const img = document.getElementById("image");
      img.src = row.image_url;
      img.style.display = "block";
    }

  } catch (err) {
    document.getElementById("equipName").innerText = "Error";
    document.getElementById("equipSubtext").innerText = err.message;
    document.getElementById("notFound").style.display = "block";

    document.getElementById("debugResponse").innerText =
      `Fetch crashed:\n${err.stack || err}`;
  }
}
</script>

</body>
</html>
