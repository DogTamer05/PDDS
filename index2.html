<!DOCTYPE html>
<html>
<head>
<title>Engine Motor Details</title>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
<style>
  .center { text-align:center; }
</style>
</head>
<body class="w3-light-grey">

<div class="w3-content" style="max-width:800px">

  <header class="w3-container w3-center w3-padding-32"> 
    <h1 id="equipName">Loading...</h1>
    <p id="equipSubtext">Fetching equipment details...</p>
    <!-- Debugging: show raw JSON response -->
    <pre id="debugResponse" style="text-align:left; max-height:200px; overflow:auto; background:#f1f1f1; padding:10px; border-radius:5px;"></pre>
  </header>

  <div class="w3-card-4 w3-white w3-margin" id="infoCard" style="display:none;">
    <div class="w3-container w3-padding">
      <h2>Equipment Info</h2>
      <p><b>Description:</b> <span id="description">—</span></p>
      <img id="image" src="" alt="Equipment Image" style="width:100%;display:none;">
    </div>
  </div>

  <div class="center w3-margin" id="notFound" style="display:none;">
    <h3>⚠ No equipment found for this QR code</h3>
  </div>

</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const scannedCode = urlParams.get("code");

console.log("QR Code received:", scannedCode);

if (!scannedCode) {
  document.getElementById("equipName").innerText = "Invalid Access";
  document.getElementById("equipSubtext").innerText = "No QR code was provided.";
}

async function fetchEquipment() {
  try {
    const response = await fetch(
      "https://ttdahvmsqjfarktnnxui.supabase.co/functions/v1/fetch-equipment",
      {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0ZGFodm1zcWpmYXJrdG5ueHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MDc5NzcsImV4cCI6MjA4MDM4Mzk3N30.-zkEnkG8Abr9CA8YrianySfXoZwPnZ31MpsUIuA1-u8"
        },
        body: JSON.stringify({ qr: scannedCode })
      }
    );

    const text = await response.text(); // read raw text first
    let data;
    try {
      data = JSON.parse(text); // try parsing JSON
    } catch {
      data = { error: "Invalid JSON response", raw: text };
    }

    // Show full debug in UI
    document.getElementById("debugResponse").innerText = JSON.stringify({
      status: response.status,
      statusText: response.statusText,
      body: data
    }, null, 2);

    if (!response.ok || data.error) {
      document.getElementById("equipName").innerText = "Error";
      document.getElementById("equipSubtext").innerText = `Request failed: ${response.status} ${response.statusText}`;
      document.getElementById("notFound").style.display = "block";
      return;
    }

    // Success: fill the UI
    document.getElementById("infoCard").style.display = "block";
    document.getElementById("equipName").innerText = data.equipment_name ?? "Equipment";
    document.getElementById("equipSubtext").innerText = data.type ?? "Details";
    document.getElementById("description").innerText = data.description ?? "No description";

    if (data.image_url) {
      const img = document.getElementById("image");
      img.src = data.image_url;
      img.style.display = "block";
    }

  } catch (err) {
    // Catch network errors, etc.
    document.getElementById("equipName").innerText = "Error";
    document.getElementById("equipSubtext").innerText = `Failed to fetch: ${err.message}`;
    document.getElementById("debugResponse").innerText = JSON.stringify(err, null, 2);
  }
}

fetchEquipment();
</script>

</body>
</html>
